name: Auth - Vercel Preview Alias
on: [deployment_status]
concurrency:
  group: deployment-${{ github.event.deployment.id }}-auth
  cancel-in-progress: false

jobs:
  pr_number:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.get_pr.outputs.pr_number }}
    steps:
      - name: Get Pull Request from Deployment Ref
        id: get_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DEPLOYMENT_SHA="${{ github.event.deployment.sha }}"
          echo "Looking for PR associated with commit $DEPLOYMENT_SHA"

          # Query GitHub API for PR associated with the commit and branch
          PR_DATA=$(gh api repos/${{ github.repository }}/commits/$DEPLOYMENT_SHA/pulls --jq ".[] | .")
          
          # Extract PR number if it exists
          if [ -z "$PR_DATA" ]; then
            echo "No PR associated with commit $DEPLOYMENT_SHA on branch $DEPLOYMENT_REF."
            exit 1
          else
            PR_NUMBER=$(echo "$PR_DATA" | jq '.number')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi
  vercel_alias:
    if: github.event.deployment_status.state == 'success' && github.event.deployment.environment == 'Preview â€“ auth'
    needs: pr_number
    runs-on: ubuntu-latest
    steps:
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      - name: Generate Domain Cert in Vercel
        run: vercel --scope ${{ vars.VERCEL_TEAM_ID }} cert issue auth.pr-${{needs.pr_number.outputs.result}}.props.host --token ${{ secrets.VERCEL_ACCESS_TOKEN }}
      - name: Get Vercel's Alias Preview URL
        id: alias-preview-url
        uses: justincase-jp/vercel-preview-url-alias@0.2.1
        with:
          vercel_access_token: ${{ secrets.VERCEL_ACCESS_TOKEN }}
          vercel_team_id: ${{ vars.VERCEL_TEAM_ID }}
          vercel_project_id: ${{ vars.VERCEL_AUTH_PROJECT_ID }}
          alias_template: 'auth.pr-${{needs.pr_number.outputs.result}}.props.host'
      - name: GitHub comment on success
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{needs.pr_number.outputs.result}},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ Auth preview deployment successfull at ${{steps.alias-preview-url.outputs.preview_url_alias}}'
            })
  comment_failute:
    if: github.event.deployment_status.state == 'failure'
    needs: pr_number
    runs-on: ubuntu-latest
    steps:
      - name: GitHub comment on failute
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{needs.pr_number.outputs.result}},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ›‘ Auth preview deployment failed'
            })