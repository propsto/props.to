name: E2E Tests

permissions:
  contents: read
  pull-requests: write
  deployments: read

on:
  deployment_status:

jobs:
  e2e:
    name: Run E2E Tests
    # Only run when a preview deployment succeeds
    if: |
      github.event.deployment_status.state == 'success' &&
      startsWith(github.event.deployment.environment, 'Preview')
    runs-on: ubuntu-latest

    steps:
      - name: Get project info
        id: project
        run: |
          ENV="${{ github.event.deployment.environment }}"
          PROJECT=$(echo "$ENV" | rev | cut -d' ' -f1 | rev | tr '[:upper:]' '[:lower:]')
          echo "name=$PROJECT" >> $GITHUB_OUTPUT

      - name: Get PR number
        id: pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DEPLOYMENT_SHA="${{ github.event.deployment.sha }}"
          PR_NUMBER=$(gh api repos/${{ github.repository }}/commits/$DEPLOYMENT_SHA/pulls --jq ".[0].number")
          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" == "null" ]; then
            echo "No PR found for this deployment"
            exit 0
          fi
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Define preview URLs
        id: urls
        run: |
          PR_NUM="${{ steps.pr.outputs.number }}"
          HOST="${{ vars.PROPSTO_HOST }}"
          echo "app=https://app.pr-${PR_NUM}.${HOST}" >> $GITHUB_OUTPUT
          echo "auth=https://auth.pr-${PR_NUM}.${HOST}" >> $GITHUB_OUTPUT

      - name: Check if both previews are ready
        id: check-previews
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DEPLOYMENT_SHA="${{ github.event.deployment.sha }}"

          # Get all deployments for this commit
          DEPLOYMENTS=$(gh api repos/${{ github.repository }}/deployments \
            --jq "[.[] | select(.sha == \"$DEPLOYMENT_SHA\" and (.environment | startswith(\"Preview\")))]")

          APP_READY=false
          AUTH_READY=false

          # Check each deployment's status
          for row in $(echo "$DEPLOYMENTS" | jq -r '.[] | @base64'); do
            _jq() { echo ${row} | base64 --decode | jq -r ${1}; }
            ENV=$(_jq '.environment')
            ID=$(_jq '.id')

            STATUS=$(gh api repos/${{ github.repository }}/deployments/$ID/statuses --jq ".[0].state")

            if [[ "$ENV" == *"app"* ]] && [[ "$STATUS" == "success" ]]; then
              APP_READY=true
            fi
            if [[ "$ENV" == *"auth"* ]] && [[ "$STATUS" == "success" ]]; then
              AUTH_READY=true
            fi
          done

          echo "App ready: $APP_READY"
          echo "Auth ready: $AUTH_READY"
          echo "app_ready=$APP_READY" >> $GITHUB_OUTPUT
          echo "auth_ready=$AUTH_READY" >> $GITHUB_OUTPUT

          if [[ "$APP_READY" == "true" ]] && [[ "$AUTH_READY" == "true" ]]; then
            echo "both_ready=true" >> $GITHUB_OUTPUT
          else
            echo "both_ready=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if not all previews ready
        if: steps.check-previews.outputs.both_ready != 'true'
        run: |
          echo "Not all previews are ready yet. Skipping E2E tests."
          echo "This workflow will run again when the other preview is deployed."

      - name: Checkout code
        if: steps.check-previews.outputs.both_ready == 'true'
        uses: actions/checkout@v4

      - name: Setup pnpm
        if: steps.check-previews.outputs.both_ready == 'true'
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        if: steps.check-previews.outputs.both_ready == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        if: steps.check-previews.outputs.both_ready == 'true'
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        if: steps.check-previews.outputs.both_ready == 'true'
        run: |
          cd e2e/auth && pnpm exec playwright install --with-deps chromium
          cd ../app && pnpm exec playwright install chromium

      - name: Run Auth E2E tests
        if: steps.check-previews.outputs.both_ready == 'true'
        env:
          AUTH_URL: ${{ steps.urls.outputs.auth }}
        run: |
          cd e2e/auth
          pnpm exec playwright test --reporter=line

      - name: Run App E2E tests
        if: steps.check-previews.outputs.both_ready == 'true'
        env:
          PROPSTO_APP_URL: ${{ steps.urls.outputs.app }}
          AUTH_URL: ${{ steps.urls.outputs.auth }}
        run: |
          cd e2e/app
          pnpm exec playwright test --reporter=line

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure() && steps.check-previews.outputs.both_ready == 'true'
        with:
          name: e2e-results-pr-${{ steps.pr.outputs.number }}
          path: |
            e2e/*/test-results/
          retention-days: 7

      - name: Comment on PR with results
        if: always() && steps.check-previews.outputs.both_ready == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const success = '${{ job.status }}' === 'success';
            const appUrl = '${{ steps.urls.outputs.app }}';
            const authUrl = '${{ steps.urls.outputs.auth }}';

            const body = success
              ? `✅ **E2E Tests Passed**\n\nTested against:\n- App: ${appUrl}\n- Auth: ${authUrl}`
              : `❌ **E2E Tests Failed**\n\nTested against:\n- App: ${appUrl}\n- Auth: ${authUrl}\n\n[View details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
